@page "/loans/activeloans/{pathUsername?}"
@using DTOs.Loan
@using DTOs.Error_Handler
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.WebUtilities
@inject BlazorApp.Services.LoanService.ILoanService LoanService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject AuthProvider AuthProvider

<AuthorizeView>
    <Authorized>
        <div class="container mt-5">
            <h2 class="text-center mb-4">Active Loans for @displayedUsername</h2>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="alert alert-warning text-center" role="alert">
                    @errorMessage
                </div>
            }

            @if (loans == null)
            {
                <div class="text-center text-muted fst-italic">Loading active loans...</div>
            }
            else if (loans.Count == 0)
            {
                <div class="text-center text-muted fst-italic">No active loans found.</div>
            }
            else
            {
                <div class="list-group">
                    @foreach (var loan in loans)
                    {
                        <LoanItem OriginalLoan="loan" OnExtendRequested="HandleExtendRequest" />
                    }
                </div>
            }
        </div>
    </Authorized>

    <NotAuthorized>
        <div class="container mt-5">
            <div class="alert alert-danger text-center">
                <h5>You must be logged in to view active loans.</h5>
                <button class="btn btn-primary mt-3" @onclick='() => NavigationManager.NavigateTo("/login")'>Go to Login</button>
            </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

<ConfirmationDialog IsVisible="showDialog" Title="Extend Loan" Message="@($"Are you sure you want to extend the loan for Book ID {selectedLoan?.BookId}?")" OnConfirm="OnConfirm" OnCancel="OnCancel" />

@code {
    [Parameter]
    public string? pathUsername { get; set; }

    private List<LoanDTO>? loans;
    private string? errorMessage;
    private string? displayedUsername;
    private LoanDTO? selectedLoan;
    private bool showDialog = false;

    protected override async Task OnInitializedAsync()
    {
        // Parse username query parameter
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);
        string? username = null;
        if (query.TryGetValue("username", out var usernameValues))
            username = usernameValues.FirstOrDefault();

        // If not in query, check the route parameter
        if (string.IsNullOrEmpty(username) && !string.IsNullOrEmpty(pathUsername))
        {
            // support URLs like /loans/activeloans/username=john or /loans/activeloans/john
            if (pathUsername.StartsWith("username=", StringComparison.OrdinalIgnoreCase))
                username = pathUsername.Substring("username=".Length);
            else
                username = pathUsername;
        }

        // If still not found, try to extract from the authentication state (recommended)
        if (string.IsNullOrEmpty(username))
        {
            try
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var user = authState.User;
                if (user?.Identity?.IsAuthenticated == true)
                {
                    // Prefer Name claim, then 'sub' then other username claim
                    username = user.Identity.Name ?? user.Claims.FirstOrDefault(c => c.Type == "sub")?.Value ?? user.Claims.FirstOrDefault(c => c.Type == "username")?.Value;
                }
            }
            catch { }
        }

        // Fallback: try the token extractor if still null
        if (string.IsNullOrEmpty(username))
        {
            try
            {
                username = AuthProvider.ExtractUsernameFromJwt();
            }
            catch { }
        }

        displayedUsername = username ?? "Unknown";

        if (!string.IsNullOrEmpty(username))
        {
            await LoadActiveLoans(username);
        }
        else
        {
            errorMessage = "No username provided in route/query and not found in token or auth state.";
        }
    }

    private async Task LoadActiveLoans(string? username)
    {
        if (string.IsNullOrEmpty(username))
        {
            errorMessage = "No username provided to load active loans.";
            loans = new List<LoanDTO>();
            return;
        }

        try
        {
            loans = await LoanService.GetActiveLoansAsync(username);
            errorMessage = null;
        }
        catch (Exception e)
        {
            // Try to parse server JSON error into ErrorResponseDTO and show a friendly message
            string content = e.Message ?? e.ToString();
            string friendly = null;

            try
            {
                var parsed = JsonSerializer.Deserialize<ErrorResponseDTO>(content, new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
                if (parsed != null)
                {
                    friendly = parsed.Details ?? parsed.Message ?? parsed.ErrorCode;
                }
            }
            catch
            {
                // not JSON or parsing failed
            }

            if (string.IsNullOrEmpty(friendly))
            {
                // If it's long JSON-like text, try to extract 'message' field manually
                try
                {
                    using var doc = JsonDocument.Parse(content);
                    if (doc.RootElement.TryGetProperty("details", out var det)) friendly = det.GetString();
                    else if (doc.RootElement.TryGetProperty("message", out var msg)) friendly = msg.GetString();
                }
                catch { }
            }

            if (string.IsNullOrEmpty(friendly))
            {
                // Fallback to trimmed content (limit length so UI doesn't dump huge JSON)
                friendly = content.Length > 500 ? content.Substring(0, 500) + "..." : content;
            }

            errorMessage = friendly;
        }
    }

    private void HandleExtendRequest(LoanDTO loan)
    {
        selectedLoan = loan;
        showDialog = true;
    }

    private async Task OnConfirm()
    {
        if (selectedLoan != null)
        {
            bool success = await LoanService.ExtendLoanAsync(selectedLoan.LoanId);
            if (success)
            {
                await LoadActiveLoans(displayedUsername);
            }
            else
            {
                errorMessage = "Failed to extend the loan.";
            }
        }
        showDialog = false;
        selectedLoan = null;
    }

    private void OnCancel()
    {
        showDialog = false;
        selectedLoan = null;
    }
}

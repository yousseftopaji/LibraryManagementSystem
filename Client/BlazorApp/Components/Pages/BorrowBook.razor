@using DTOs
@using DTOs.Loan
@inject BlazorApp.Services.LoanService.ILoanService LoanService

<div class="mt-3">
    <button class="btn btn-success" @onclick="ShowConfirmation" disabled="@isProcessing">
        @if (isProcessing)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        }
        Borrow
    </button>
     <button class="btn btn-warning ms-2"
            disabled="@isExtending"
            @onclick="ShowExtendConfirmation">
        @if (isExtending)
        {
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
        }
        Extend Loan
    </button>
</div>

<ConfirmationDialog IsVisible="@showConfirmDialog" Title="Confirm Borrow"
    Message="Are you sure you want to borrow this book?" ConfirmText="Yes, Borrow" CancelText="Cancel"
    ConfirmButtonClass="btn-success" OnConfirm="HandleBorrow" OnCancel="HideConfirmation" />
<ConfirmationDialog IsVisible="@showExtendDialog"
    Title="Extend Loan"
    Message="Do you want to extend this loan?"
    ConfirmText="Extend"
    CancelText="Cancel"
    ConfirmButtonClass="btn-warning"
    OnConfirm="HandleExtend"
    OnCancel="HideExtendConfirmation" />
@if (!string.IsNullOrEmpty(message))
{
    <div class="alert @(isError ? "alert-danger" : "alert-success") mt-3" role="alert">
        @message
    </div>
}

@code {
    [Parameter]
    public required string ISBN { get; set; }
public required int LoanId { get; set; }
    [Parameter]
    public EventCallback OnBorrowSuccess { get; set; }
public EventCallback OnExtendSuccess { get; set; }
    private bool isProcessing = false;
    private string message = string.Empty;
    private bool isError = false;
    private bool showConfirmDialog = false;
private bool isExtending = false;
    private bool showExtendDialog = false;
    private void ShowConfirmation()
    {
        showConfirmDialog = true;
    }

    private void HideConfirmation()
    {
        showConfirmDialog = false;
    }

    private async Task HandleBorrow()
    {
        showConfirmDialog = false;
        isProcessing = true;
        message = string.Empty;
        isError = false;

        try
        {
            var createLoanDTO = new CreateLoanDTO
            {
                BookISBN = ISBN,
                Username = "alice123" // TODO: Replace with actual logged-in username
            };

            var loanResponseDto = await LoanService.CreateLoanAsync(createLoanDTO);
            Console.WriteLine(loanResponseDto);
            message = "Book successfully borrowed!";
            isError = false;

            // Notify parent component to refresh book details
            await OnBorrowSuccess.InvokeAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error borrowing book: {ex}");
            message = "Failed to borrow the book. Please try again.";
            isError = true;
        }
        finally
        {
            isProcessing = false;
        }
    }
     private void ShowExtendConfirmation() => showExtendDialog = true;
    private void HideExtendConfirmation() => showExtendDialog = false;

    private async Task HandleExtend()
    {
        showExtendDialog = false;
        isExtending = true;
        isError = false;
        message = "";

        try
        {
            
            var dto = new ExtendLoanDTO
            {
                LoanId = LoanId,
                Username = "alice123"

            };

            await LoanService.ExtendLoanAsync(dto);

            message = "Loan successfully extended!";
            isError = false;

            await OnExtendSuccess.InvokeAsync();
        }
        catch (Exception ex)
        {
            message = $"Failed to extend loan: {ex.Message}";
            isError = true;
        }
        finally
        {
            isExtending = false;
        }
    }
}
}
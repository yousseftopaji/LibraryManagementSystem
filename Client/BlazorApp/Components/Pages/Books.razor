@page "/books"
@using DTOs.Book
@using Microsoft.AspNetCore.Components.Authorization
@inject Services.IBookService BookService
@inject NavigationManager NavigationManager

@* <AuthorizeView>
    <Authorized> *@
        <h3>Books</h3>

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-warning" role="alert">
                @errorMessage
            </div>
        }

        @if (books == null)
        {
            <p class="text-muted fst-italic">Loading books...</p>
        }
        else if (books.Count == 0)
        {
            <p class="text-muted fst-italic">No books available.</p>
        }
        else
        {
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Title</th>
                        <th>Author</th>
                        <th>ISBN</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var book in books)
                    {
                        <tr style="cursor: pointer;" @onclick="@(() => NavigateToBook(book.ISBN))">
                            <td>@book.Title</td>
                            <td>@book.Author</td>
                            <td>@book.ISBN</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    @* </Authorized>

    <NotAuthorized>
        <div class="alert alert-danger text-center">
            You must be logged in to view books. <br />
            <button class="btn btn-primary mt-2" @onclick="@(() => NavigationManager.NavigateTo("/login"))">Go to Login</button>
        </div>
    </NotAuthorized>
</AuthorizeView> *@

@code {
    private List<BookDTO>? books;
    private string? errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await GetBooks();
    }

    private async Task GetBooks()
    {
        try
        {
            books = await BookService.GetBooksAsync();
            errorMessage = null;
        }
        catch (Exception)
        {
            errorMessage = "Unable to connect to server. Please try again later.";
            books = new List<BookDTO>(); // Initialize empty list to show empty table
        }
    }

    private void NavigateToBook(string? isbn)
    {
        if (!string.IsNullOrEmpty(isbn))
        {
            NavigationManager.NavigateTo($"/books/{isbn}");
        }
    }
}
